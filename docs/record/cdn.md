## 背景
临时接手负责一个官网的项目，分为前台和后台，前台的大部分页面是用后台的一套CMS管理系统生成的
## 遇到的问题
发起请求后，如果等待时间较长，会出现以下两种情况
1. 重复请求两次 ,nginx收到两条请求信息， ip是不同的,一条是499，一条是200，但是两条请求都已经被后端处理了 

```code
203.205.251.56 - - [29/Feb/2024:13:48:57 +0000] "POST /api/route1/route2/ HTTP/1.1" 499 0 "https://domain.com/api/route1/route2" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36"

203.205.249.216 - - [29/Feb/2024:13:48:57 +0000] "POST /api/route1/route2/ HTTP/1.1" 200 71 "https://domain.com/api/route1/route2" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36"
``` 

2. 只请求一次，但是chrome出现   (failed)net::ERR_HTTP2_PROTOCOL_ERROR，nginx此时只收到一条请求信息，状态码为499 

```code
203.205.221.183 - - [29/Feb/2024:13:56:28 +0000] "POST /api/route1/route2/ HTTP/1.1" 499 0 "https://domain.com/api/route1/route2" "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36"
```

## 排查思路
客户端访问接口```https://domain.com/api/route1/route2```,  该域名配置了CDN加速，最终映射到服务器43.xx.xx.xx， 服务器nginx再反向代理到后端服务，
直接走服务器ip访问这个nginx的代理是没问题的，只有走域名才会出现问题，所以初步断定是CDN加速发起了重试，由于对CDN不太了解，开始学习相关知识
## CDN是什么
1. 缓存：CDN通过在全球各地部署的缓存服务器存储内容的副本。当用户请求特定内容时，CDN会根据用户的位置和网络拓扑关系，将内容从最近的缓存服务器中提供给用户，而不是从原始服务器获取内容。

2. 负载均衡：CDN使用负载均衡技术来分发流量并确保各个缓存服务器之间的负载均衡。负载均衡可以根据服务器的性能和负载情况，将用户请求分配到最合适的服务器上，以确保高效的内容传输。

3. 边缘节点：CDN在全球各地部署大量的边缘节点，这些节点接近终端用户，可以更快地响应用户请求。边缘节点通常位于互联网服务提供商的数据中心或云服务提供商的设施中。

3. 动态内容加速：CDN不仅可以缓存静态内容（如图片、视频、网页等），还可以加速动态内容（如数据库查询、个性化内容等）。CDN可以通过缓存动态内容的结果或将请求转发到最快的服务器来提高动态内容的传输速度。

4. 内容路由：CDN可以根据用户的位置、网络状态和请求内容，选择最优的内容路由路径。内容路由可以帮助减少延迟、提高带宽利用率和增强网络稳定性。

5. 内容优化：CDN可以对内容进行优化，例如压缩、图片优化、视频转码等，以减少传输时间和带宽消耗。

### 腾讯云CDN解释
1. 用户向 www.test.com 下的某图片资源（如：1.jpg）发起请求，会先向 Local DNS 发起域名解析请求。 

2. 当 Local DNS 解析 www.test.com 时，会发现已经配置了 CNAME www.test.com.cdn.dnsv1.com，解析请求会发送至 Tencent DNS（GSLB），GSLB 为腾讯云自主研发的调度体系，会为请求分配最佳节点 IP。 

3. Local DNS 获取 Tencent DNS 返回的解析 IP。 

4. 用户获取解析 IP。 

5. 用户向获取的 IP 发起对资源 1.jpg 的访问请求。 

6. 若该 IP 对应的节点缓存有 1.jpg，则会将数据直接返回给用户（10），此时请求结束。若该节点未缓存 1.jpg，则节点会向业务源站发起对 1.jpg 的请求（6、7、8），获取资源后，结合用户自定义配置的缓存策略（可参考产品文档中的 缓存过期配置，将资源缓存至节点（9），并返回给用户（10），此时请求结束。 

## CDN里的API加速是什么
跟静态资源的加速类似
## 什么是回源
回源是指CDN中缓存失效后，CDN节点需要从源服务器重新获取内容并更新缓存，腾讯云默认的回源超时时间为15秒，在用于API加速时，超过15秒的请求会重试，也就导致了之前的问题


